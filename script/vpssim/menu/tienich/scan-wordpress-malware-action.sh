#!/bin/bash
if [ ! -f /tmp/server_wp_all_update ] && [ -f /home/vpssim.conf ]; then
. /home/vpssim.conf
fi


echoY() {
    echo -e "\033[38;5;148m${1}\033[39m"
}
echoG() {
    echo -e "\033[38;5;71m${1}\033[39m"
}
echoR()
{
    echo -e "\033[38;5;203m${1}\033[39m"
}


#
cd ~
echo $(date) > /root/scan-wordpress-malware-log.txt

#
echo -n "Enter dir for check and update (default /home): "
read DirSetup
if [ "$DirSetup" == "" ]; then
DirSetup="/home"
fi

if [ ! -d $DirSetup ]; then
echoR $DirSetup" not exist..."
exit
fi

echo -n "Max dir for foreach (maximum 10, default 3): "
read MaxCheck
if [ "$MaxCheck" == "" ]; then
MaxCheck=3
#elif [ "$MaxCheck" -gt 10 ]; then
#MaxCheck=10
fi

#if [ -f /etc/init.d/directadmin ] && [ ! "$DirSetup" == "/home" ]; then
if [ ! "$DirSetup" == "/home" ]; then
echo -n "chmod to user (default: auto detect): "
read chUser
chmodUser=$chUser
fi


#
echoG "OK OK, scan wordpres upload website in: "$DirSetup
echo "Max for: "$MaxCheck
echo "Will begin after 2s..."
sleep 2



#
cd ~


find_and_check_file_mimetype(){
echo $1
if [ -d "$1" ]; then
	for d in $1/*
	do
		if [ -d "$d" ]; then
			echo $d
			basename_d=$(basename $d)
			if [ ! "$basename_d" == "ebcache" ]; then
				find_and_check_file_mimetype $d
			fi
		elif [ -f "$d" ]; then
			#filename $(basename $d)
			filename=$(basename -- "$d")
			extension="${filename##*.}"

			#
			mime_type=$(file -b --mime-type $d)
			#echo $mime_type

			# kiểm tra định dạng file xem có khớp với mime type không
			has_log=""
			if [ "$mime_type" == "video/mp4" ]; then
				if [ ! "$extension" == "mp4" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "image/jpeg" ]; then
				if [ ! "$extension" == "jpg" ] && [ ! "$extension" == "jpeg" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "image/png" ]; then
				if [ ! "$extension" == "png" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "image/x-ms-bmp" ]; then
				if [ ! "$extension" == "bmp" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "image/svg+xml" ]; then
				if [ ! "$extension" == "svg" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "image/gif" ]; then
				if [ ! "$extension" == "gif" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "text/plain" ]; then
				if [ ! "$extension" == "css" ] && [ ! "$extension" == "json" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/octet-stream" ]; then
				if [ ! "$extension" == "webp" ] && [ ! "$extension" == "bmp" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/pdf" ]; then
				if [ ! "$extension" == "pdf" ]; then
					has_log="warning"
				fi
			else
				has_log="unknown"
			fi

			# nếu không khớp -> ghi log
			if [ ! "$has_log" == "" ]; then
				echoY $d"::"$extension"::"$mime_type
				echo $d"::"$mime_type >> /root/scan-wordpress-malware-log.txt
			fi
		else
			echo $d
		fi
	done
else
	echo "Dir not exist::"$d
fi
}


# tim tat ca thu muc trong home
get_all_dir_in_dir(){
echo "--------------------------------------------------------"
echo "Pram 1: "$1
echo "Pram 2: "$2
echo "Pram 3: "$3
echo "Pram 4: "$4

# do sau toi da se kiem tra
if [ $2 -lt $3 ]; then
	for d in $1
	do
		# neu la thu muc thi kiem tra tiep
		if [ -d $d ]; then
			# neu la shortcut thi bo qua
			if [ -L $d ]; then
				echoY $d"::It is a symlink..."
			else
				#echo $d
				# tim it nhat 3 file va 3 thu muc bat buoc phai co cua wp
				if [ -f $d/wp-config.php ] && [ -f $d/wp-settings.php ] && [ -f $d/wp-blog-header.php ] && [ -d $d/wp-admin ] && [ -d $d/wp-content ] && [ -d $d/wp-includes ]; then
					echo $d
					# tim duoc website wp
					echoY $d"::It is a wordpress website"
					
					find_and_check_file_mimetype $d"/wp-content/uploads"
					echo "Scan wordpress upload DONE..."
					sleep 3;
				else
					#echo $d
					stt=$2
					let "stt+=1"
					#echo $stt
					get_all_dir_in_dir $d"/*" $stt $3 $4
				fi
			fi
		fi
	done
fi
}


# lap tim cac website trong thu muc home
WP_update_main(){
echo "Check WP upload in: "$DirSetup
#exit

# voi cac thu muc khac, quet thang trong thu muc
if [ ! "$DirSetup" == "/home" ]; then
	get_all_dir_in_dir $DirSetup"/*" 0 $MaxCheck $host_user
else

# voi thu muc home thi moi can do theo host
for d_home in $DirSetup/*
do
	# neu la thu muc -> tim cac file wp trong nay
	if [ -d $d_home ]; then
		echo "d home: "$d_home
		
		# tai khoan de chmod file sau khi update
		if [ "$chmodUser" == "" ]; then
			host_user=$(basename $d_home)
		else
			host_user=$chmodUser
		fi
		echo "host user: "$host_user
		
		get_all_dir_in_dir $d_home"/*" 0 $MaxCheck $host_user
		
		echo "========================================"
	fi
done

fi

}
WP_update_main



#
cd ~
echo $(date) >> /root/scan-wordpress-malware-log.txt

#
if [ ! -f /tmp/server_wp_all_update ] && [ -f /home/vpssim.conf ]; then
/etc/vpssim/menu/vpssim-tien-ich
fi
