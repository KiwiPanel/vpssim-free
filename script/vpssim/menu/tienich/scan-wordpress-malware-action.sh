#!/bin/bash
if [ ! -f /tmp/server_wp_all_update ] && [ -f /home/vpssim.conf ]; then
. /home/vpssim.conf
fi
echoY() {
echo -e "\033[38;5;148m${1}\033[39m"
}
echoG() {
echo -e "\033[38;5;71m${1}\033[39m"
}
echoR()
{
echo -e "\033[38;5;203m${1}\033[39m"
}
#
cd ~
echo $(date) > /root/scan-wordpress-malware-log.txt
#
echo -n "Enter folder for check and scan (default /home): "
read root_dir
if [ "$root_dir" == "" ]; then
root_dir="/home"
fi
if [ ! -d $root_dir ]; then
echoR $root_dir" not exist..."
exit
fi

echo -n "Maximum folder for foreach (maximum 10, default 3): "
read MaxCheck
if [ "$MaxCheck" == "" ]; then
MaxCheck=3
fi

if [ ! "$root_dir" == "/home" ]; then
echo -n "chmod to user (default: auto detect): "
read chUser
chmodUser=$chUser
fi

#
displayLog=0
echo -n "Show log after done (default: y | Please choose: y/n): "
read showDoneLog
if [ "$showDoneLog" == "" ] || [ "$showDoneLog" == "y" ]; then
displayLog=1
fi

#
echoG "OK OK, scan wordpres upload website in: "$root_dir
echo "Max for: "$MaxCheck
echo "Show log: "$showDoneLog
echo "Will begin after 2s..."
sleep 2

#
cd ~
find_and_check_file_mimetype(){
echo "Dir scan: "$1

#
sub_scan="yes"
if [ "$2" == "no" ]; then
	sub_scan="no"
fi
echo "Sub scan: "$sub_scan

#
if [ -d "$1" ]; then
	for scan_d in $1/*
	do
		if [ -d "$scan_d" ]; then
			echo $scan_d
			basename_d=$(basename $scan_d)
			# khong scan thu muc ebcache, va chi scan thu muc con khi co yeu cau
			if [ ! "$basename_d" == "ebcache" ] && [ ! "$sub_scan" == "no" ]; then
				find_and_check_file_mimetype $scan_d
			else
				echo "Disable scan sub-folder"
			fi
		elif [ -f "$scan_d" ]; then
			#filename $(basename $scan_d)
			filename=$(basename -- "$scan_d")
			extension="${filename##*.}"
			#
			mime_type=$(file -b --mime-type $scan_d)
			#echo $mime_type

			# mang chua cac gia tri can so sanh
			arr_mime_type_image=("image/jpeg","image/png","image/x-ms-bmp","image/svg+xml","image/gif")

			# kiểm tra định dạng file xem có khớp với mime type không
			has_log=""
			if [ "$mime_type" == "video/mp4" ]; then
				if [ ! "$extension" == "mp4" ]; then
					has_log="warning"
				fi
			elif [[ "${arr_mime_type_image[*]}" =~ "${mime_type}" ]]; then
				arr_ext_image=("jpg","jpeg","png","bmp","svg","gif")
				if [[ ! "${arr_ext_image[*]}" =~ "${extension}" ]]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "text/plain" ]; then
				arr_ext_text_plain=("css","json","js","txt","log","html")
				if [[ ! "${arr_ext_text_plain[*]}" =~ "${extension}" ]]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "text/html" ]; then
				arr_ext_text_html=("shtml","html","htm")
				if [[ ! "${arr_ext_text_html[*]}" =~ "${extension}" ]]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "text/x-php" ]; then
				if [ ! "$extension" == "php" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/octet-stream" ]; then
				if [ ! "$extension" == "webp" ] && [ ! "$extension" == "bmp" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/pdf" ]; then
				if [ ! "$extension" == "pdf" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/x-gzip" ]; then
				if [ ! "$extension" == "gz" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/msword" ]; then
				if [ ! "$extension" == "docx" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/xml" ] || [ "$mime_type" == "application/xml-sitemap" ]; then
				if [ ! "$extension" == "xml" ]; then
					has_log="warning"
				fi
			elif [ "$mime_type" == "application/zip" ]; then
				if [ ! "$extension" == "zip" ]; then
					has_log="warning"
				fi
			else
				has_log="unknown"
			fi
			# nếu không khớp -> ghi log
			if [ ! "$has_log" == "" ]; then
				echoY $scan_d"::"$extension"::"$mime_type
				#echo $extension" :: "$scan_d"::"$mime_type >> /root/scan-wordpress-malware-log.txt
				echo $scan_d >> /root/scan-wordpress-malware-log.txt
				echo $mime_type"::"$extension >> /root/scan-wordpress-malware-log.txt
			fi
		else
			echo $scan_d
		fi
	done
else
	echo "Dir not exist::"$scan_d
fi
}
# tim tat ca thu muc trong home
get_all_dir_in_dir(){
echo "--------------------------------------------------------"
echo "Dir scan: "$1
echo "Re-scan: "$2
echo "Max scan: "$3
echo "Host user: "$4
# do sau toi da se kiem tra
if [ $2 -lt $3 ]; then
	for get_d in $1
	do
		# neu la thu muc thi kiem tra tiep
		if [ -d $get_d ]; then
			# neu la shortcut thi bo qua
			if [ -L $get_d ]; then
				echoY $get_d"::It is a symlink..."
			else
				#echo $get_d
				# tim it nhat 3 file va 3 thu muc bat buoc phai co cua wp
				if [ -f $get_d/wp-config.php ] && [ -f $get_d/wp-settings.php ] && [ -f $get_d/wp-blog-header.php ] && [ -d $get_d/wp-admin ] && [ -d $get_d/wp-content ] && [ -d $get_d/wp-includes ]; then
					#echo $get_d
					# tim duoc website wp
					echoG $get_d"::It is a wordpress website"
					
					# thu kiem tra xem site nay co dinh malware khong
					echoY "Check malware..."
					if [ -f $get_d/index.php ]; then
						iFile=$get_d/index.php
						# thu tim chuoi base64_decode trong file index php -> mac dinh thi file index php khong co doan nay
						if grep -q base64_decode "$iFile"; then
							# gui canh bao ve telegram
							#wget --no-check-certificate -O /dev/null "https://cloud.echbay.com/backups/has_malware?source=index.php&path=$get_d"
							curl --data "source=index.php&path="$get_d https://cloud.echbay.com/backups/has_malware
						fi
					fi
					# file logo.gif nay cung do virus tao ra
					if [ -f $get_d/logo.gif ]; then
						# gui canh bao ve telegram
						#wget --no-check-certificate -O /dev/null "https://cloud.echbay.com/backups/has_malware?source=logo.gif&path=$get_d"
						curl --data "source=logo.gif&path="$get_d https://cloud.echbay.com/backups/has_malware
					fi
					
					# scan thu muc public_html
					find_and_check_file_mimetype $get_d "no"
					# scan thu muc upload
					find_and_check_file_mimetype $get_d"/wp-content/uploads"
					find_and_check_file_mimetype $get_d"/uploads"
					find_and_check_file_mimetype $get_d"/upload"
					find_and_check_file_mimetype $get_d"/public/uploads"
					find_and_check_file_mimetype $get_d"/public/upload"
					echoG "Scan wordpress upload DONE..."
					sleep 3;
				else
					#echo $get_d
					stt=$2
					let "stt+=1"
					#echo $stt
					get_all_dir_in_dir $get_d"/*" $stt $3 $4
				fi
			fi
		fi
	done
fi
}
# lap tim cac website trong thu muc home
WP_update_main(){
echo "Check WP upload in: "$root_dir
#exit
# voi cac thu muc khac, quet thang trong thu muc
if [ ! "$root_dir" == "/home" ]; then
	find_and_check_file_mimetype $root_dir
	echoG "Scan custom upload DONE..."
else
# voi thu muc home thi moi can do theo host
for main_dir in $root_dir/*
do
	# neu la thu muc -> tim cac file wp trong nay
	if [ -d $main_dir ]; then
		echo "d home: "$main_dir
		
		# tai khoan de chmod file sau khi update
		if [ "$chmodUser" == "" ]; then
			host_user=$(basename $main_dir)
		else
			host_user=$chmodUser
		fi
		echo "host user: "$host_user
		
		get_all_dir_in_dir $main_dir"/*" 0 $MaxCheck $host_user
		
		echo "========================================"
	fi
done
fi
}
WP_update_main
#
cd ~
echo $(date) >> /root/scan-wordpress-malware-log.txt

#
if [ "$displayLog" -ne 0 ]; then
nano /root/scan-wordpress-malware-log.txt
else
echo "nano /root/scan-wordpress-malware-log.txt"
fi

#
if [ ! -f /tmp/server_wp_all_update ] && [ -f /home/vpssim.conf ]; then
/etc/vpssim/menu/vpssim-tien-ich
fi
